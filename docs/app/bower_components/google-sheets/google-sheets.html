<html><head><link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../google-signin/google-signin-aware.html">



</head><body><dom-module id="google-sheets">
  <template>
    <template is="dom-if" if="{{!published}}">
      <google-signin-aware client-id="{{clientId}}" scopes="https://spreadsheets.google.com/feeds" on-google-signin-aware-success="_onSignInSuccess" on-google-signin-aware-signed-out="_onSignInFail"></google-signin-aware>
    </template>

    <iron-ajax id="publicajax" params="{&quot;alt&quot;: &quot;json&quot;}" handle-as="json" on-response="_onCellRows"></iron-ajax>
    <iron-ajax id="listsheetsajax" params="{&quot;alt&quot;: &quot;json&quot;}" handle-as="json" on-response="_onSpreadsheetList"></iron-ajax>
    <iron-ajax id="worksheetajax" params="{&quot;alt&quot;: &quot;json&quot;}" handle-as="json" on-response="_onWorksheet"></iron-ajax>
    <iron-ajax id="cellrowsajax" params="{&quot;alt&quot;: &quot;json&quot;}" handle-as="json" on-response="_onCellRows"></iron-ajax>

  </template>
</dom-module>

<script>!function(){function e(){return this._worksheetId+"_"+this.tabId}function t(e,t){for(var s,a=0;s=t[a];++a)if(s.rel===e)return s;return null}var s="https://spreadsheets.google.com/feeds",a={};window.GoogleSheets=Polymer({is:"google-sheets",hostAttributes:{hidden:!0},properties:{clientId:{type:String,value:"",observer:"_configUpdate"},key:{type:String,value:"",observer:"_keyChanged"},tabId:{type:Number,value:1,observer:"_configUpdate"},published:{type:Boolean,value:!1,observer:"_configUpdate"},sheet:{type:Object,value:function(){return{}},readOnly:!0,notify:!0,observer:"_sheetChanged"},tab:{type:Object,value:function(){return{}},readOnly:!0,notify:!0,observer:"_tabChanged"},rows:{type:Array,value:function(){return[]},readOnly:!0,notify:!0},spreadsheets:{type:Array,readOnly:!0,notify:!0,value:function(){return[]}},openInGoogleDocsUrl:{type:String,computed:"_computeGoogleDocsUrl(key)",notify:!0}},_worksheetId:null,_computeGoogleDocsUrl:function(e){var t="https://docs.google.com/spreadsheet/";return e&&(t+="ccc?key="+e),t},_configUpdate:function(e,t,s,a){this._tabIdChanged()},_keyChanged:function(e,t){if(this.published){var a=s+"/list/"+this.key+"/"+this.tabId+"/public/values";this.$.publicajax.url=a,this.$.publicajax.generateRequest()}},_tabIdChanged:function(e,t){this._worksheetId?this._getCellRows():this.published&&this._keyChanged()},_sheetChanged:function(e,t){if(this.sheet.title){var s=this.sheet.author&&this.sheet.author.map(function(e){return{email:e.email.$t,name:e.name.$t}});this.set("sheet.title",this.sheet.title.$t),this.set("sheet.updated",new Date(this.sheet.updated.$t)),this.set("sheet.authors",s),this._worksheetId=this.sheet.id.$t.split("/").slice(-1)[0],this._getWorksheet()}},_tabChanged:function(e,t){if(this.tab.title){var s=this.tab.authors=this.tab.author&&this.tab.author.map(function(e){return{email:e.email.$t,name:e.name.$t}});this.set("tab.title",this.tab.title.$t),this.set("tab.updated",new Date(this.tab.updated.$t)),this.set("tab.authors",s),this.fire("google-sheet-data",{type:"tab",data:this.tab})}},_onSignInSuccess:function(e,t){var s=gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse(),a={Authorization:"Bearer "+s.access_token};this.$.listsheetsajax.headers=a,this.$.worksheetajax.headers=a,this.$.cellrowsajax.headers=a,this._listSpreadsheets()},_onSignInFail:function(e,t){console.log(e,e.type)},_listSpreadsheets:function(){var e=s+"/spreadsheets/private/full";this.$.listsheetsajax.url=e,this.$.listsheetsajax.generateRequest()},_onSpreadsheetList:function(e){e.stopPropagation();var s=e.target.lastResponse.feed;if(this._setSpreadsheets(s.entry),this.fire("google-sheet-data",{type:"spreadsheets",data:this.spreadsheets}),this.key)for(var a,i=0;a=s.entry[i];++i){var r=t("alternate",a.link);if(r&&r.href.indexOf(this.key)!=-1){this._setSheet(a);break}}},_getWorksheet:function(){if(!this._worksheetId)throw new Error("workesheetId was not given.");var e=s+"/worksheets/"+this._worksheetId+"/private/full/"+this.tabId;this.$.worksheetajax.url=e,this.$.worksheetajax.generateRequest()},_onWorksheet:function(e){e.stopPropagation(),this._setTab(e.target.lastResponse.entry),this._getCellRows()},_getCellRows:function(){var t=e.call(this);if(t in a)return void this._onCellRows(null,null,a[t]);var i=s+"/list/"+this._worksheetId+"/"+this.tabId+"/private/full";this.$.cellrowsajax.url=i,this.$.cellrowsajax.generateRequest()},_onCellRows:function(t){t.stopPropagation();var s=t.target.lastResponse.feed,i=e.call(this);i in a||(a[i]={response:{feed:s}}),this._setRows(s.entry);var r=s.author&&s.author.map(function(e){return{email:e.email.$t,name:e.name.$t}});this.set("rows.authors",r),this.published&&this._setTab(s),this.fire("google-sheet-data",{type:"rows",data:this.rows})}})}();</script>
</body></html>