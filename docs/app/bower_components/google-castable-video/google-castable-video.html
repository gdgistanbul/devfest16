<html><head><link rel="import" href="../polymer/polymer.html">
<link rel="import" href="google-cast-sender-api.html">


<script>!function(){var e=250;Polymer({is:"google-castable-video",extends:"video",properties:{appId:{type:String,value:null}},listeners:{seeked:"_onSeeked",volumechange:"_onVolumechange",timeupdate:"_onTimeupdate"},_bothPaused:!0,get bothPaused(){return this._bothPaused},get bothCurrentTime(){return this._casting&&this._castMedia?this._castMedia.getEstimatedTime():this.currentTime},set bothCurrentTime(e){return this.currentTime=e},_casting:!1,get casting(){return this._casting},_receiverAvailable:!1,get receiverAvailable(){return this._receiverAvailable},_castMedia:null,get castMedia(){return this._castMedia},_session:null,get session(){return this._session},ready:function(){window.__onGCastApiAvailable=function(e,t){e?this._initializeCastApi():this._triggerError("INITIALIZE_ERROR")}.bind(this)},_initializeCastApi:function(){null!==this.appId&&"undefined"!=typeof this.appId||(this.appId=chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID);var t=new chrome.cast.SessionRequest(this.appId),i=new chrome.cast.ApiConfig(t,function(t){this._triggerCasting(!0),this._session=t,this._session.media.length&&this._onMediaDiscovered.call(this,"onRequestSessionSuccess",this._session.media[0]),this._session.addUpdateListener(this._sessionUpdateListener.bind(this)),this._timeupdateInterval=setInterval(function(){this._castMedia&&"PLAYING"===this._castMedia.playerState?(this._triggerTimeupdate(this._castMedia.getEstimatedTime()),this._bothPaused=!1):this._bothPaused=!0}.bind(this),e),this.paused||(this.play(),this.pause(!1))}.bind(this),function(e){e===chrome.cast.ReceiverAvailability.AVAILABLE?this._triggerAvailability(!0):this._triggerAvailability(!1)}.bind(this));chrome.cast.initialize(i,function(){this.fire("google-castable-video-initialized")}.bind(this),function(){this._triggerError("INITIALIZE_ERROR")})},launchSessionManager:function(){this._receiverAvailable&&chrome.cast.requestSession(function(t){this._triggerCasting(!0),this._session=t,this._session.addUpdateListener(this._sessionUpdateListener.bind(this)),this.paused||(this.play(),this.pause(!1)),this._timeupdateInterval=setInterval(function(){this._castMedia&&"PLAYING"===this._castMedia.playerState?(this._triggerTimeupdate(this._castMedia.getEstimatedTime()),this._bothPaused=!1):this._bothPaused=!0}.bind(this),e)}.bind(this))},_sessionUpdateListener:function(e){e||(this._triggerCasting(!1),this._synchronizeMedia(!0),"PLAYING"===this._castMedia.playerState&&this.play(),this._castMedia=null,this._session=null,clearInterval(this._timeupdateInterval))},_onMediaDiscovered:function(e,t){this._castMedia=t,"loadMedia"===e&&this._synchronizeMedia(!1)},_synchronizeMedia:function(e){if(e){var t=this._castMedia.getEstimatedTime();this.currentTime=t}else{var t=this.currentTime,i=new chrome.cast.media.SeekRequest;i.currentTime=t,this._castMedia.seek(i)}},play:function(e){if(void 0!=e&&!e||!e&&!this._casting)Object.getPrototypeOf(Object.getPrototypeOf(this)).play.call(this);else if(this._castMedia)this._castMedia.play();else{var t=new chrome.cast.media.MediaInfo(this.currentSrc);[].forEach.call(document.querySelectorAll("video source"),function(e){e.getAttribute("src").split("/").pop()===this.currentSrc.split("/").pop()&&(t.contentType=e.getAttribute("type"))}.bind(this));var i=new chrome.cast.media.LoadRequest(t);this._session.loadMedia(i,this._onMediaDiscovered.bind(this,"loadMedia"),function(e){this._triggerError("LOAD_MEDIA_ERROR")}.bind(this))}},pause:function(e){void 0!=e&&!e||!e&&!this._casting?Object.getPrototypeOf(Object.getPrototypeOf(this)).pause.call(this):this._castMedia.pause()},_triggerTimeupdate:function(e){this.fire("google-castable-video-timeupdate",{currentTime:e})},_triggerError:function(e){this.fire("google-castable-video-error",{error:e})},_triggerAvailability:function(e){this._receiverAvailable=e,this.fire("google-castable-video-receiver-status",{available:e})},_triggerCasting:function(e){this._casting=e,this.fire("google-castable-video-casting",{casting:e})},_onSeeked:function(){if(this._casting){var e=new chrome.cast.media.SeekRequest;e.currentTime=this.currentTime,this._castMedia.seek(e)}},_onVolumechange:function(){if(this._casting){var e=new chrome.cast.Volume(this.volume,this.muted),t=new chrome.cast.media.VolumeRequest(e);this._castMedia.setVolume(t)}},_onTimeupdate:function(){this._triggerTimeupdate(this.currentTime),this._bothPaused=this.paused}})}();</script>
</head><body></body></html>